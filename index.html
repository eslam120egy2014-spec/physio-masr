<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Physio Masr Elite V35 - Stable</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --navy: #023652; --teal: #1cb5b5; --bg: #f4f7f9; --card: #ffffff; --border: #e2e8f0; --neon-glow: 0 0 15px rgba(28, 181, 181, 0.6); --red: #ff4757; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; color: #2d3748; padding-bottom: 100px; overflow-x: hidden; }

        #splash-screen { position: fixed; inset: 0; background: var(--navy); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .pulse-logo { width: 180px; height: auto; animation: pulse-anim 2s infinite ease-in-out; }
        .welcome-text { margin-top: 15px; color: var(--teal); font-size: 24px; font-weight: 900; opacity: 0; animation: fadeInUp 0.8s forwards 0.5s; }
        @keyframes pulse-anim { 0%, 100% { transform: scale(0.95); opacity: 0.9; } 50% { transform: scale(1.02); opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        header { background: var(--navy); height: 90px; display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 0 20px; border-bottom: 3px solid var(--teal); position: sticky; top: 0; z-index: 1000; }
        .header-logo { height: 60px; width: auto; justify-self: end; }
        .user-tag { color: white; font-size: 15px; font-weight: 700; background: rgba(255,255,255,0.08); padding: 8px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }

        .container { padding: 15px; max-width: 480px; margin: auto; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 20px; border-radius: 18px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        label { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 10px; }
        .label-icon { width: 18px; height: 18px; color: var(--teal); stroke-width: 2.5; fill: none; stroke: currentColor; }
        .icon { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; fill: none; }

        .input, select, textarea { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1.5px solid var(--border); font-size: 14px; font-family: inherit; margin-bottom: 12px; }
        
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; left: 0; background: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 12px; z-index: 2005; border: 1px solid var(--border); overflow: hidden; }
        .dropdown-content button { width: 100%; padding: 12px; border: none; background: none; text-align: right; font-family: inherit; font-size: 13px; font-weight: bold; cursor: pointer; border-bottom: 1px solid #eee; }
        .show { display: block; }

        .cal-head { background: var(--navy); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; border-radius: 18px 18px 0 0; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; padding: 8px; border-radius: 10px; color: var(--teal); cursor: pointer; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: white; padding: 12px; border-radius: 0 0 18px 18px; border: 1px solid var(--border); text-align: center; }
        .day { height: 42px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; border-radius: 10px; position: relative; }
        .day.selected { background: var(--teal); color: white; box-shadow: var(--neon-glow); transform: scale(1.1); z-index: 2; }
        .day.has-v::after { content: ''; position: absolute; bottom: 5px; width: 5px; height: 5px; background: #f59e0b; border-radius: 50%; }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 75px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 2000; }
        .nav-link { color: #94a3b8; text-decoration: none; font-size: 11px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-link.active { color: var(--teal); }

        .btn-neon { background: var(--teal); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 900; width: 100%; box-shadow: var(--neon-glow); margin-top: 10px; cursor: pointer; }
        
        #employee-hub { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: none; flex-direction: column; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .hub-header { background: var(--navy); padding: 15px; color: white; border-bottom: 3px solid var(--teal); }
        .hub-content { padding: 15px; overflow-y: auto; flex: 1; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 18px; border: 1px solid var(--border); text-align: center; }
        .stat-val { display: block; font-size: 24px; font-weight: 900; color: var(--teal); }
        .stat-lbl { font-size: 11px; font-weight: 700; color: var(--navy); opacity: 0.8; }

        .progress-container { background: rgba(255,255,255,0.15); border-radius: 10px; height: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: var(--teal); height: 100%; width: 0%; transition: 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-item { background: var(--navy); color: white; padding: 6px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="https://j.top4top.io/p_3692l51ap0.png" class="pulse-logo">
        <div id="splash-user-text" class="welcome-text"></div>
    </div>

    <div id="login-screen" style="position:fixed; inset:0; background:var(--navy); z-index:9000; display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        <img src="https://j.top4top.io/p_3692l51ap0.png" style="width:200px; margin-bottom:40px;">
        <input type="text" id="user-input" class="input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…ÙˆØ¸Ù Ø§Ù„ØªØ³ÙˆÙŠÙ‚" style="max-width:300px; text-align:center;">
        <button onclick="firstTimeLogin()" class="btn-neon" style="max-width:300px;">Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</button>
    </div>

    <header id="app-header" style="display:none;">
        <div id="user-display" class="user-tag" onclick="toggleHub(true)"></div>
        <img src="https://j.top4top.io/p_3692l51ap0.png" class="header-logo">
    </header>

    <div id="employee-hub">
        <div class="hub-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight: 900; font-size: 18px;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</span>
                <button onclick="toggleHub(false)" style="background:none; border:none; color:white; font-size:28px;">Ã—</button>
            </div>
        </div>
        <div class="hub-content">
            <div class="stat-grid">
                <div class="stat-box"><span id="st-visits" class="stat-val">0</span><span class="stat-lbl">Ø²ÙŠØ§Ø±Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</span></div>
                <div class="stat-box"><span id="st-comps" class="stat-val">0</span><span class="stat-lbl">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù…ÙŠØ²ÙŠÙ†</span></div>
            </div>

            <div class="card" style="border: none; background: linear-gradient(135deg, #023652 0%, #054a6d 100%); color: white;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="background: rgba(28, 181, 181, 0.2); padding: 8px; border-radius: 12px; display: flex;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#1cb5b5" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                        </div>
                        <span style="font-weight: 900; font-size: 15px;">Ù‡Ø¯Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</span>
                    </div>
                    <span id="target-pct" style="font-weight: 900; color: var(--teal); background: white; padding: 2px 8px; border-radius: 8px; font-size: 12px;">0%</span>
                </div>
                <div class="progress-container"><div id="target-bar" class="progress-bar"></div></div>
                <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:11px; font-weight:bold; opacity:0.8;">
                    <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                    <span>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: 60 Ø²ÙŠØ§Ø±Ø©</span>
                </div>
            </div>

            <div class="card">
                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ù†Ø´Ø§Ø·Ø§Ù‹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</label>
                <div id="top-zones" class="tag-list"></div>
            </div>

            <button onclick="downloadMonthlyPDF()" class="btn-neon" style="background:var(--navy); margin-top:20px;">ğŸ“„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ PDF</button>
        </div>
    </div>

    <div class="container" id="app-content" style="display:none;">
        <div id="p-home" class="page active">
            <div class="cal-head">
                <button class="nav-btn" onclick="moveMonth(-1)"><svg style="width:20px;height:20px" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="3"/></svg></button>
                <span id="month-label" style="font-weight:900;"></span>
                <button class="nav-btn" onclick="moveMonth(1)"><svg style="width:20px;height:20px" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="3"/></svg></button>
            </div>
            <div class="cal-grid" id="calendar"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:25px;">
                <h3 style="font-size:18px; margin:0; color:var(--navy);">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                <div class="dropdown">
                    <button onclick="toggleDrop()" style="background:var(--navy); color:white; border:none; padding:8px 15px; border-radius:10px; font-weight:bold; font-size:12px;">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± â–¼</button>
                    <div id="reportDrop" class="dropdown-content">
                        <button onclick="shareWA()">ğŸŸ¢ WhatsApp</button>
                        <button onclick="downloadPDF()">ğŸ“„ Ù…Ù„Ù PDF Ø§Ù„ÙŠÙˆÙ…</button>
                    </div>
                </div>
            </div>
            <div id="daily-visits" style="margin-top:15px;"></div>
        </div>

        <div id="p-add" class="page">
            <div class="card">
                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M3 21h18M3 7l9-4 9 4v10H3V7z"/></svg> Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
                <input type="text" id="comp-name" list="comp-dl" class="input">
                <datalist id="comp-dl"></datalist>
                
                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="comp-zone" class="input" onchange="checkNewZone(this)"></select>

                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</label>
                <div id="persons-container"></div>
                <button onclick="addPerson()" style="width:100%; border:1px solid #ddd; padding:8px; border-radius:10px; margin-bottom:15px; font-size:12px; background:none;">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„</button>

                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Ù…Ù„Ø®Øµ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
                <textarea id="v-note" class="input" rows="3"></textarea>
                
                <input type="hidden" id="v-location">
                <p id="gps-status" style="font-size:11px; color:var(--teal); text-align:center; margin-top:-10px;"></p>
                
                <button onclick="saveVisit()" class="btn-neon">Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
            </div>
        </div>

        <div id="p-data" class="page">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <button onclick="exportData()" style="padding:10px; border-radius:10px; border:1px solid #ddd; background:white; font-size:12px; font-weight:bold;">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <button onclick="document.getElementById('imp-f').click()" style="padding:10px; border-radius:10px; border:1px solid #ddd; background:white; font-size:12px; font-weight:bold;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <input type="file" id="imp-f" style="display:none" onchange="importData(event)">
            </div>
            <input type="text" id="comp-search" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..." oninput="renderComps()">
            <div id="company-list"></div>
        </div>
    </div>

    <div id="details-modal" onclick="closeModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000; padding:20px; align-items:center; justify-content:center;">
        <div class="card" style="width:100%; max-width:400px; max-height:80vh; overflow-y:auto;" onclick="event.stopPropagation()">
            <h2 id="modal-title" style="color:var(--navy); margin-top:0;"></h2>
            <div id="modal-content"></div>
            <button class="btn-neon" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="pdf-template" style="display:none; padding:40px; font-family:'Cairo';">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--navy); padding-bottom:10px;">
            <div><h1 style="color:var(--navy); margin:0;">ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª ÙÙŠØ²ÙŠÙˆ Ù…ØµØ±</h1><p id="pdf-user-info"></p></div>
            <img src="https://j.top4top.io/p_3692l51ap0.png" style="height:70px;">
        </div>
        <p id="pdf-date-info" style="margin-top:15px; font-weight:bold;"></p>
        <table border="1" style="width:100%; border-collapse:collapse; margin-top:10px; text-align:right;">
            <thead style="background:#f0f4f8;"><tr><th style="padding:10px;">Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„Ù…Ù„Ø®Øµ</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th></tr></thead>
            <tbody id="pdf-body"></tbody>
        </table>
    </div>

    <nav id="app-nav" style="display:none;">
        <div class="nav-link active" onclick="tab('p-home', this)"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-link" onclick="tab('p-add', this); getLocation();"><svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>ØªØ³Ø¬ÙŠÙ„</div>
        <div class="nav-link" onclick="tab('p-data', this)"><svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20M4 19.5V3A2.5 2.5 0 0 1 6.5 0.5H20v16.5H6.5a2.5 2.5 0 0 0-2.5 3z"/></svg>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
    </nav>

    <script>
        // Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let db = JSON.parse(localStorage.getItem('PHYSIO_V35')) || { 
            user: "", visits: [], companies: [], zones: ["Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ", "Ø§Ù„Ø¯Ù‚ÙŠ", "Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±", "Ø§Ù„Ù…Ù‚Ø·Ù…", "Ø­Ù„ÙˆØ§Ù†", "Ø§Ù„Ø¹Ø¨ÙˆØ±"]
        };
        let viewM = new Date(), selD = new Date().toDateString();

        window.onload = function() { 
            if (!db.user) document.getElementById('login-screen').style.display = 'flex'; 
            else runSplash(); 
            if(!document.getElementById('persons-container').children.length) addPerson(); 
        };

        function firstTimeLogin() { const u = document.getElementById('user-input').value.trim(); if(u){ db.user=u; refresh(); runSplash(); } }
        
        function runSplash() { 
            document.getElementById('login-screen').style.display = 'none'; 
            const s = document.getElementById('splash-screen'); 
            document.getElementById('splash-user-text').innerText = db.user; 
            s.style.display = 'flex'; 
            setTimeout(() => { s.style.opacity = '0'; s.style.transition = '0.5s'; setTimeout(() => { s.style.display = 'none'; start(); }, 500); }, 2000); 
        }

        function start() { 
            document.getElementById('app-header').style.display='grid'; 
            document.getElementById('app-content').style.display='block'; 
            document.getElementById('app-nav').style.display='flex'; 
            document.getElementById('user-display').innerText = db.user; 
            refresh(); 
        }

        function refresh() { 
            localStorage.setItem('PHYSIO_V35', JSON.stringify(db)); 
            renderCal(); renderVisits(); renderComps(); renderHubStats();
            document.getElementById('comp-zone').innerHTML = db.zones.map(z => `<option>${z}</option>`).join('') + `<option value="NEW">+ Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>`; 
            document.getElementById('comp-dl').innerHTML = db.companies.map(c => `<option value="${c.name}">`).join(''); 
        }

        function renderHubStats() {
            const mVisits = db.visits.filter(v => {
                const d = new Date(v.date);
                return d.getMonth() === viewM.getMonth() && d.getFullYear() === viewM.getFullYear();
            });
            document.getElementById('st-visits').innerText = mVisits.length;
            document.getElementById('st-comps').innerText = new Set(mVisits.map(v => v.company)).size;
            let pct = Math.min(Math.round((mVisits.length / 60) * 100), 100);
            document.getElementById('target-bar').style.width = pct + '%';
            document.getElementById('target-pct').innerText = pct + '%';
            let zCounts = {};
            mVisits.forEach(v => {
                const c = db.companies.find(co => co.name === v.company);
                if(c) zCounts[c.zone] = (zCounts[c.zone] || 0) + 1;
            });
            let sorted = Object.entries(zCounts).sort((a,b) => b[1]-a[1]).slice(0,3);
            document.getElementById('top-zones').innerHTML = sorted.map(z => `<div class="tag-item">${z[0]} (${z[1]})</div>`).join('') || '<small>Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</small>';
        }

        function getLocation() { 
            const s = document.getElementById('gps-status'); 
            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition((pos) => { 
                    document.getElementById('v-location').value = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`; 
                    s.innerText = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…"; 
                }, () => { s.innerText = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹."; }); 
            } 
        }
        
        function saveVisit() {
            const name = document.getElementById('comp-name').value.trim();
            const zone = document.getElementById('comp-zone').value;
            const note = document.getElementById('v-note').value.trim();
            if(!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©");
            
            let pList = []; 
            document.querySelectorAll('#persons-container > div').forEach(d => { 
                const n = d.querySelector('.p-name').value.trim(); 
                if(n) pList.push({ title: d.querySelector('.p-title').value, name: n, phone: d.querySelector('.p-phone').value }); 
            });

            let cIdx = db.companies.findIndex(c => c.name === name);
            if(cIdx === -1) db.companies.push({ name, zone, persons: pList, location: document.getElementById('v-location').value });
            else { db.companies[cIdx].zone = zone; if(pList.length) db.companies[cIdx].persons = pList; }
            
            db.visits.push({ company: name, note, date: selD, timestamp: new Date().toLocaleTimeString('ar-EG') });
            
            document.getElementById('comp-name').value=''; 
            document.getElementById('v-note').value=''; 
            document.getElementById('persons-container').innerHTML = ''; 
            addPerson();
            refresh(); 
            tab('p-home', document.querySelectorAll('.nav-link')[0]); 
        }

        function generatePDF(data, fileName) {
            document.getElementById('pdf-user-info').innerText = `Ø§Ù„Ù…ÙˆØ¸Ù: ${db.user}`;
            document.getElementById('pdf-date-info').innerText = `Ø§Ù„ÙØªØ±Ø©: ${fileName.replace(/_/g, ' ')}`;
            let rows = "";
            data.forEach(v => {
                const c = db.companies.find(co => co.name === v.company) || {};
                const p = c.persons && c.persons[0] ? c.persons[0].name : '-';
                rows += `<tr><td style="padding:10px;">${v.company}</td><td>${c.zone || '-'}</td><td>${p}</td><td>${v.note}</td><td>${v.timestamp || ''}</td></tr>`;
            });
            document.getElementById('pdf-body').innerHTML = rows;
            const el = document.getElementById('pdf-template');
            el.style.display = 'block';
            html2pdf().from(el).set({ margin: 10, filename: `${fileName}.pdf`, image: { type: 'jpeg', quality: 0.98 } }).save().then(() => el.style.display = 'none');
        }

        function downloadMonthlyPDF() {
            const mVisits = db.visits.filter(v => {
                const d = new Date(v.date);
                return d.getMonth() === viewM.getMonth() && d.getFullYear() === viewM.getFullYear();
            });
            if(!mVisits.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±");
            generatePDF(mVisits, `ØªÙ‚Ø±ÙŠØ±_Ø´Ù‡Ø±_${viewM.getMonth()+1}`);
        }

        function downloadPDF() {
            const vT = db.visits.filter(v => v.date === selD);
            if(!vT.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…");
            generatePDF(vT, `ØªÙ‚Ø±ÙŠØ±_ÙŠÙˆÙ…_${selD}`);
        }

        function shareWA() {
            const f = db.visits.filter(v => v.date === selD);
            if(!f.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª");
            let fullMsg = "*ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…*%0A";
            f.forEach(v => {
                const c = db.companies.find(co => co.name === v.company) || {};
                fullMsg += `%0AğŸ“ ${c.zone} | ğŸ¢ ${v.company}%0AğŸ“ ${v.note}%0Aâ° ${v.timestamp}%0A---%0A`;
            });
            window.open(`https://wa.me/?text=${fullMsg}`);
        }

        function renderCal() { 
            const grid = document.getElementById('calendar'); grid.innerHTML = ''; 
            const y = viewM.getFullYear(), m = viewM.getMonth(); 
            document.getElementById('month-label').innerText = viewM.toLocaleDateString('ar-EG', {month:'long', year:'numeric'}); 
            const first = new Date(y, m, 1).getDay(); const days = new Date(y, m+1, 0).getDate(); 
            for(let i=0; i<first; i++) grid.innerHTML += '<div></div>'; 
            for(let d=1; d<=days; d++) { 
                let dStr = new Date(y, m, d).toDateString(); 
                grid.innerHTML += `<div class="day ${dStr === selD ? 'selected' : ''} ${db.visits.some(v=>v.date===dStr)?'has-v':''}" onclick="selD='${dStr}'; refresh();">${d}</div>`; 
            } 
        }

        function renderVisits() { 
            const f = db.visits.filter(v => v.date === selD); 
            document.getElementById('daily-visits').innerHTML = f.map(v => `<div class="card" style="border-right:5px solid var(--teal)"><b>${v.company}</b><br><small>${v.note}</small></div>`).join('') || '<p style="text-align:center; opacity:0.5;">Ù„Ø§ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>'; 
        }

        function renderComps() { 
            const s = document.getElementById('comp-search').value.toLowerCase(); 
            const f = db.companies.filter(c => c.name.toLowerCase().includes(s) || c.zone.toLowerCase().includes(s)); 
            document.getElementById('company-list').innerHTML = f.map(c => `<div class="card" onclick="showCompDetails('${c.name.replace(/'/g, "\\'")}')" style="display:flex; justify-content:space-between; align-items:center;"><div><b>${c.name}</b><br><small>ğŸ“ ${c.zone}</small></div><svg style="width:14px; color:var(--teal);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6" /></svg></div>`).join(''); 
        }

        function showCompDetails(name) { 
            const c = db.companies.find(co => co.name === name); 
            const vs = db.visits.filter(v => v.company === name); 
            document.getElementById('modal-title').innerText = c.name; 
            let h = `<p><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${c.zone}</p>`; 
            if(c.location) h += `<p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> <a href="${c.location}" target="_blank" style="color:var(--teal);">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ğŸ“</a></p>`; 
            h += `<hr><h4>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†:</h4>`; (c.persons||[]).forEach(p => h += `<p>â€¢ ${p.title}/ ${p.name} (${p.phone})</p>`); 
            h += `<hr><h4>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª:</h4>`; vs.forEach(v => h += `<p style="font-size:12px; border-bottom:1px solid #eee; padding:5px 0;">ğŸ“… ${v.date}: ${v.note}</p>`); 
            document.getElementById('modal-content').innerHTML = h; 
            document.getElementById('details-modal').style.display = 'flex'; 
        }
        
        function addPerson() { 
            const div = document.createElement('div'); div.style.display = "flex"; div.style.gap = "5px"; div.style.marginBottom = "8px"; 
            div.innerHTML = `<select class="input p-title" style="width:90px;"><option>Ø¯ÙƒØªÙˆØ±</option><option>Ø£Ø³ØªØ§Ø°</option></select><input type="text" class="input p-name" placeholder="Ø§Ù„Ø§Ø³Ù…" style="flex:1;"><input type="tel" class="input p-phone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" style="flex:1;">`; 
            document.getElementById('persons-container').appendChild(div); 
        }

        function toggleHub(show) { document.getElementById('employee-hub').style.display = show ? 'flex' : 'none'; }
        function closeModal() { document.getElementById('details-modal').style.display = 'none'; }
        function moveMonth(n) { viewM.setMonth(viewM.getMonth()+n); refresh(); }
        function tab(id, el) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
            el.classList.add('active'); 
        }
        function checkNewZone(sel) { if(sel.value === "NEW") { const n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:"); if(n) { db.zones.push(n); refresh(); sel.value = n; } else sel.selectedIndex = 0; } }
        function toggleDrop() { document.getElementById("reportDrop").classList.toggle("show"); }
        function exportData() { const blob = new Blob([JSON.stringify(db)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Physio_Backup_${new Date().toLocaleDateString()}.json`; a.click(); }
        function importData(e) { const r = new FileReader(); r.onload = ev => { try { db = JSON.parse(ev.target.result); refresh(); alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…"); } catch(err) { alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"); } }; r.readAsText(e.target.files[0]); }
    </script>
</body>

</html>
