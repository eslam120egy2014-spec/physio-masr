<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Physio Masr Elite V50 - Text Delete & PDF Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { --navy: #023652; --teal: #1cb5b5; --bg: #f4f7f9; --card: #ffffff; --border: #e2e8f0; --neon-glow: 0 0 15px rgba(28, 181, 181, 0.6); --red: #ff4757; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; color: #2d3748; padding-bottom: 100px; overflow-x: hidden; }

        #splash-screen { position: fixed; inset: 0; background: var(--navy); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .pulse-logo { width: 180px; height: auto; animation: pulse-anim 2s infinite ease-in-out; }
        .welcome-text { margin-top: 15px; color: var(--teal); font-size: 24px; font-weight: 900; opacity: 0; animation: fadeInUp 0.8s forwards 0.5s; }
        @keyframes pulse-anim { 0%, 100% { transform: scale(0.95); opacity: 0.9; } 50% { transform: scale(1.02); opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        header { background: var(--navy); height: 90px; display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 0 20px; border-bottom: 3px solid var(--teal); position: sticky; top: 0; z-index: 1000; }
        .header-logo { height: 60px; width: auto; justify-self: end; }
        .user-tag { color: white; font-size: 15px; font-weight: 700; background: rgba(255,255,255,0.08); padding: 8px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }

        .container { padding: 15px; max-width: 480px; margin: auto; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 20px; border-radius: 18px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        label { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 10px; }
        .label-icon { width: 18px; height: 18px; color: var(--teal); stroke-width: 2.5; fill: none; stroke: currentColor; }
        .icon { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; fill: none; }

        .input, select, textarea { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1.5px solid var(--border); font-size: 14px; font-family: inherit; margin-bottom: 12px; }
        
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; left: 0; background: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 12px; z-index: 2005; border: 1px solid var(--border); overflow: hidden; }
        .dropdown-content button { width: 100%; padding: 12px; border: none; background: none; text-align: right; font-family: inherit; font-size: 13px; font-weight: bold; cursor: pointer; border-bottom: 1px solid #eee; }
        .show { display: block; }

        .cal-head { background: var(--navy); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; border-radius: 18px 18px 0 0; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; padding: 8px; border-radius: 10px; color: var(--teal); cursor: pointer; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: white; padding: 12px; border-radius: 0 0 18px 18px; border: 1px solid var(--border); text-align: center; }
        .day { height: 42px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; border-radius: 10px; position: relative; }
        .day.selected { background: var(--teal); color: white; box-shadow: var(--neon-glow); transform: scale(1.1); z-index: 2; }
        .day.has-v::after { content: ''; position: absolute; bottom: 5px; width: 5px; height: 5px; background: #f59e0b; border-radius: 50%; }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 75px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 2000; }
        .nav-link { color: #94a3b8; text-decoration: none; font-size: 11px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-link.active { color: var(--teal); }

        .btn-neon { background: var(--teal); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 900; width: 100%; box-shadow: var(--neon-glow); margin-top: 10px; cursor: pointer; }
        .btn-small { background: var(--teal); color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ© */
        .delete-btn {
            background: var(--red);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .delete-btn.small {
            padding: 4px 8px;
            font-size: 11px;
        }
        .delete-btn:hover {
            opacity: 0.9;
        }
        
        #employee-hub { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: none; flex-direction: column; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .hub-header { background: var(--navy); padding: 15px; color: white; border-bottom: 3px solid var(--teal); }
        .hub-content { padding: 15px; overflow-y: auto; flex: 1; }

        /* ØªÙ†Ø³ÙŠÙ‚ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù‡Ø¨ */
        .hub-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .hub-tab { padding: 8px 16px; background: #eee; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .hub-tab.active { background: var(--teal); color: white; }
        .hub-tab-content { display: none; }
        .hub-tab-content.active { display: block; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 18px; border: 1px solid var(--border); text-align: center; }
        .stat-val { display: block; font-size: 24px; font-weight: 900; color: var(--teal); }
        .stat-lbl { font-size: 11px; font-weight: 700; color: var(--navy); opacity: 0.8; }

        .progress-container { background: rgba(255,255,255,0.15); border-radius: 10px; height: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: var(--teal); height: 100%; width: 0%; transition: 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-item { background: var(--navy); color: white; padding: 6px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; }

        /* Checkbox group styles */
        .days-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 12px; }
        .days-checkbox-group label { display: inline-flex; align-items: center; gap: 5px; font-size: 13px; font-weight: normal; margin-bottom: 0; cursor: pointer; }
        .planned-day-badge { background: var(--teal); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .company-item { cursor: pointer; transition: 0.2s; touch-action: pan-y; user-select: none; -webkit-tap-highlight-color: transparent; }
        .company-item:active { background: #f0f0f0; }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ØµÙØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡Ø¨ */
        .admin-day-tab { padding: 8px 12px; background: #eee; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .admin-day-tab.active { background: var(--teal); color: white; }
        .plan-company-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: white; padding: 10px; border-radius: 12px; border: 1px solid var(--border); cursor: grab; }
        .plan-company-row:active { cursor: grabbing; }
        .plan-company-info { flex: 1; cursor: pointer; }
        .drag-handle { font-size: 20px; color: #aaa; margin-left: 5px; }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .company-list-scroll { max-height: 70vh; overflow-y: auto; padding-left: 5px; -webkit-overflow-scrolling: touch; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ÙÙŠ Ø§Ù„ØªØ­ÙƒÙ… */
        .multi-select-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        .multi-select-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-bottom: 1px solid #eee; }
        .multi-select-item:last-child { border-bottom: none; }
        .multi-select-item input[type="checkbox"] { width: 18px; height: 18px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙŠ Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ… */
        .persons-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; font-size: 12px; color: var(--navy); }
        .person-badge { background: #f0f7fa; padding: 2px 8px; border-radius: 12px; display: inline-flex; align-items: center; gap: 3px; }
        .add-person-btn { background: none; border: 1px dashed var(--teal); color: var(--teal); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; margin-right: 5px; }

        /* ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ Ø²Ø± Ø¥Ø²Ø§Ù„Ø© */
        .person-edit-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .person-edit-row select { width: 85px; }
        .person-edit-row input[type="text"] { flex: 2; }
        .person-edit-row input[type="tel"] { flex: 1.5; }

        /* ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ PDF */
        .pdf-container { font-family: 'Cairo', sans-serif; padding: 30px; background: white; direction: rtl; }
        .pdf-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--teal); padding-bottom: 15px; margin-bottom: 20px; }
        .pdf-header h1 { color: var(--navy); margin: 0; font-size: 24px; }
        .pdf-header img { height: 70px; }
        .pdf-info { display: flex; justify-content: space-between; background: #f0f7fa; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 14px; }
        .pdf-table { width: 100%; border-collapse: collapse; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .pdf-table th { background: var(--navy); color: white; padding: 12px; font-weight: 700; font-size: 14px; }
        .pdf-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .pdf-table tr:nth-child(even) { background: #f9f9f9; }
        .pdf-footer { margin-top: 30px; text-align: center; color: #888; font-size: 12px; border-top: 1px solid #ddd; padding-top: 15px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø£Ø³ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¥Ø²Ø§Ù„Ø© */
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; color: var(--navy); }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="https://j.top4top.io/p_3692l51ap0.png" class="pulse-logo">
        <div id="splash-user-text" class="welcome-text"></div>
    </div>

    <div id="login-screen" style="position:fixed; inset:0; background:var(--navy); z-index:9000; display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        <img src="https://j.top4top.io/p_3692l51ap0.png" style="width:200px; margin-bottom:40px;">
        <input type="text" id="user-input" class="input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…ÙˆØ¸Ù Ø§Ù„ØªØ³ÙˆÙŠÙ‚" style="max-width:300px; text-align:center;">
        <button onclick="firstTimeLogin()" class="btn-neon" style="max-width:300px;">Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</button>
    </div>

    <header id="app-header" style="display:none;">
        <div id="user-display" class="user-tag" onclick="toggleHub(true)"></div>
        <img src="https://j.top4top.io/p_3692l51ap0.png" class="header-logo">
    </header>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© (Hub) -->
    <div id="employee-hub">
        <div class="hub-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight: 900; font-size: 18px;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</span>
                <button onclick="toggleHub(false)" style="background:none; border:none; color:white; font-size:28px;">Ã—</button>
            </div>
        </div>
        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù‡Ø¨ -->
        <div class="hub-tabs">
            <div class="hub-tab active" onclick="switchHubTab('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
            <div class="hub-tab" onclick="switchHubTab('control')">ğŸ› ï¸ Ø§Ù„ØªØ­ÙƒÙ…</div>
        </div>
        <div class="hub-content">
            <!-- Ù…Ø­ØªÙˆÙ‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div id="hub-stats" class="hub-tab-content active">
                <div class="stat-grid">
                    <div class="stat-box"><span id="st-visits" class="stat-val">0</span><span class="stat-lbl">Ø²ÙŠØ§Ø±Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</span></div>
                    <div class="stat-box"><span id="st-comps" class="stat-val">0</span><span class="stat-lbl">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù…ÙŠØ²ÙŠÙ†</span></div>
                </div>

                <div class="card" style="border: none; background: linear-gradient(135deg, #023652 0%, #054a6d 100%); color: white;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="background: rgba(28, 181, 181, 0.2); padding: 8px; border-radius: 12px; display: flex;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#1cb5b5" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                            </div>
                            <span style="font-weight: 900; font-size: 15px;">Ù‡Ø¯Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</span>
                        </div>
                        <span id="target-pct" style="font-weight: 900; color: var(--teal); background: white; padding: 2px 8px; border-radius: 8px; font-size: 12px;">0%</span>
                    </div>
                    <div class="progress-container"><div id="target-bar" class="progress-bar"></div></div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:11px; font-weight:bold; opacity:0.8;">
                        <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                        <span>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: 60 Ø²ÙŠØ§Ø±Ø©</span>
                    </div>
                </div>

                <div class="card">
                    <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ù†Ø´Ø§Ø·Ø§Ù‹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</label>
                    <div id="top-zones" class="tag-list"></div>
                </div>

                <button onclick="downloadMonthlyPDF()" class="btn-neon" style="background:var(--navy); margin-top:20px;">ğŸ“„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ PDF</button>
            </div>

            <!-- Ù…Ø­ØªÙˆÙ‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ­ÙƒÙ… (Ù…Ø¹ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±) -->
            <div id="hub-control" class="hub-tab-content">
                <div class="card">
                    <h3 style="color:var(--navy); display:flex; align-items:center; gap:8px;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
                    
                    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù… -->
                    <div style="display:flex; gap:8px; overflow-x:auto; padding:10px 0; margin-bottom:10px;" id="admin-days-tabs"></div>

                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨) -->
                    <p style="font-weight:bold;">Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø© (Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨):</p>
                    <div id="admin-company-list" class="company-list-scroll" style="padding:5px; max-height: 250px;"></div>

                    <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± -->
                    <p style="font-weight:bold; margin-top:15px;">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ§Øª Ù„Ù„ÙŠÙˆÙ…:</p>
                    <div class="multi-select-list" id="multi-select-companies"></div>
                    <button onclick="addSelectedCompanies()" class="btn-neon" style="margin-top:10px;">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ÙŠÙˆÙ…</button>
                    <p style="font-size:12px; color:#888; margin-top:5px;">Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ù‡ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="app-content" style="display:none;">
        <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…) -->
        <div id="p-home" class="page active">
            <div class="cal-head">
                <button class="nav-btn" onclick="moveMonth(-1)"><svg style="width:20px;height:20px" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="3"/></svg></button>
                <span id="month-label" style="font-weight:900;"></span>
                <button class="nav-btn" onclick="moveMonth(1)"><svg style="width:20px;height:20px" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="3"/></svg></button>
            </div>
            <div class="cal-grid" id="calendar"></div>
            
            <!-- Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø©) -->
            <h3 style="font-size:18px; margin:20px 0 10px 0; color:var(--navy);">ğŸ“‹ Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
            <div id="planned-visits" style="margin-top:10px;"></div>

            <!-- Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© Ø§Ù„ÙŠÙˆÙ… -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:25px;">
                <h3 style="font-size:18px; margin:0; color:var(--navy);">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                <div class="dropdown">
                    <button onclick="toggleDrop()" style="background:var(--navy); color:white; border:none; padding:8px 15px; border-radius:10px; font-weight:bold; font-size:12px;">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± â–¼</button>
                    <div id="reportDrop" class="dropdown-content">
                        <button onclick="shareWA()">ğŸŸ¢ WhatsApp</button>
                        <button onclick="downloadPDF()">ğŸ“„ Ù…Ù„Ù PDF Ø§Ù„ÙŠÙˆÙ…</button>
                    </div>
                </div>
            </div>
            <div id="daily-visits" style="margin-top:15px;"></div>
        </div>

        <!-- ØµÙØ­Ø© Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© -->
        <div id="p-add" class="page">
            <div class="card">
                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M3 21h18M3 7l9-4 9 4v10H3V7z"/></svg> Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input type="text" id="comp-name" list="comp-dl" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
                <datalist id="comp-dl"></datalist>
                
                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="comp-zone" class="input" onchange="checkNewZone(this)"></select>

                <!-- Ø£ÙŠØ§Ù… Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
                <label><svg class="label-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Ø£ÙŠØ§Ù… Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <div class="days-checkbox-group" id="plan-days-checkboxes"></div>

                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</label>
                <div id="persons-container"></div>
                <button onclick="addPerson()" type="button" style="width:100%; border:1px solid #ddd; padding:8px; border-radius:10px; margin-bottom:15px; font-size:12px; background:none;">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„</button>

                <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© -->
                <label><svg class="label-icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="comp-general-notes" class="input" rows="2"></textarea>

                <input type="hidden" id="v-location">
                <p id="gps-status" style="font-size:11px; color:var(--teal); text-align:center; margin-top:-10px;"></p>
                
                <button onclick="saveNewCompany()" class="btn-neon">â• Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª) Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± -->
        <div id="p-data" class="page">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <button onclick="exportData()" style="padding:10px; border-radius:10px; border:1px solid #ddd; background:white; font-size:12px; font-weight:bold;">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <button onclick="document.getElementById('imp-f').click()" style="padding:10px; border-radius:10px; border:1px solid #ddd; background:white; font-size:12px; font-weight:bold;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <input type="file" id="imp-f" style="display:none" onchange="importData(event)">
            </div>
            <input type="text" id="comp-search" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..." oninput="renderComps()">
            <div id="company-list" class="company-list-scroll"></div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ (Ø¨Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„) Ù…Ø¹ Ø²Ø± Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙƒØ© -->
    <div id="edit-full-modal" onclick="closeEditFullModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:5000; padding:15px; align-items:center; justify-content:center;">
        <div class="card" style="width:100%; max-width:500px; max-height:90vh; overflow-y:auto;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 style="color:var(--navy); margin:0;">ØªØ¹Ø¯ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <button class="delete-btn" onclick="deleteCompanyFromEdit()" title="Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©">Ø¥Ø²Ø§Ù„Ø©</button>
            </div>
            <input type="hidden" id="edit-original-name">
            
            <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
            <input type="text" id="edit-name" class="input">
            
            <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <select id="edit-zone" class="input"></select>
            
            <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <div class="days-checkbox-group" id="edit-plan-days-checkboxes"></div>

            <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</label>
            <div id="edit-persons-container"></div>
            <button onclick="addPersonToEdit()" type="button" style="width:100%; border:1px solid #ddd; padding:8px; border-radius:10px; margin-bottom:15px; font-size:11px;">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„</button>

            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</label>
            <textarea id="edit-general-notes" class="input" rows="2"></textarea>

            <label>Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø£Ø­Ø¯Ø« Ø²ÙŠØ§Ø±Ø©)</label>
            <textarea id="edit-last-note" class="input" rows="3"></textarea>

            <button class="btn-neon" onclick="saveFullEdit()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            <button onclick="closeEditFullModal()" style="width:100%; background:#666; color:white; border:none; padding:12px; border-radius:14px; margin-top:8px; font-weight:bold;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø®Ø·Ø© -->
    <div id="visit-modal" onclick="closeVisitModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3500; padding:20px; align-items:center; justify-content:center;">
        <div class="card" style="width:100%; max-width:400px;" onclick="event.stopPropagation()">
            <h3 style="color:var(--navy); margin-top:0;">ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©</h3>
            <p><b id="visit-modal-company"></b> - <span id="visit-modal-date"></span></p>
            <textarea id="visit-modal-note" class="input" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©"></textarea>
            <button class="btn-neon" onclick="saveVisitFromPlan()">Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
            <button onclick="closeVisitModal()" style="width:100%; background:#666; color:white; border:none; padding:12px; border-radius:14px; margin-top:8px; font-weight:bold;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ù…Ù† Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ… -->
    <div id="add-person-modal" onclick="closeAddPersonModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3600; padding:20px; align-items:center; justify-content:center;">
        <div class="card" style="width:100%; max-width:400px;" onclick="event.stopPropagation()">
            <h3 style="color:var(--navy); margin-top:0;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù„Ø´Ø±ÙƒØ©</h3>
            <p><b id="add-person-company-name"></b></p>
            <select id="add-person-title" class="input">
                <option>Ø¯ÙƒØªÙˆØ±</option>
                <option>Ø£Ø³ØªØ§Ø°</option>
                <option>Ø£Ø³ØªØ§Ø°Ø©</option>
            </select>
            <input type="text" id="add-person-name" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
            <input type="tel" id="add-person-phone" class="input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
            <button class="btn-neon" onclick="saveNewPerson()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
            <button onclick="closeAddPersonModal()" style="width:100%; background:#666; color:white; border:none; padding:12px; border-radius:14px; margin-top:8px; font-weight:bold;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ© -->
    <div id="details-modal" onclick="closeModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000; padding:20px; align-items:center; justify-content:center;">
        <div class="card" style="width:100%; max-width:400px; max-height:80vh; overflow-y:auto;" onclick="event.stopPropagation()">
            <h2 id="modal-title" style="color:var(--navy); margin-top:0;"></h2>
            <div id="modal-content"></div>
            <button class="btn-neon" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Ù‚Ø§Ù„Ø¨ PDF Ø§Ù„Ù…Ø­Ø³Ù† -->
    <div id="pdf-template" style="display:none;">
        <div class="pdf-container">
            <div class="pdf-header">
                <h1>ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª ÙÙŠØ²ÙŠÙˆ Ù…ØµØ±</h1>
                <img src="https://j.top4top.io/p_3692l51ap0.png" alt="Physio Masr Logo">
            </div>
            <div class="pdf-info">
                <span><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> <span id="pdf-user"></span></span>
                <span><strong>Ø§Ù„ÙØªØ±Ø©:</strong> <span id="pdf-period"></span></span>
                <span><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> <span id="pdf-date"></span></span>
            </div>
            <table class="pdf-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø´Ø±ÙƒØ©</th>
                        <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                        <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                        <th>Ø§Ù„Ù…Ù„Ø®Øµ</th>
                        <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                    </tr>
                </thead>
                <tbody id="pdf-body"></tbody>
            </table>
            <div class="pdf-footer">
                ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… ÙÙŠØ²ÙŠÙˆ Ù…ØµØ± Ù„Ù„ØªØ³ÙˆÙŠÙ‚ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
            </div>
        </div>
    </div>

    <nav id="app-nav" style="display:none;">
        <div class="nav-link active" onclick="tab('p-home', this)"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-link" onclick="tab('p-add', this); getLocation();"><svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©</div>
        <div class="nav-link" onclick="tab('p-data', this)"><svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20M4 19.5V3A2.5 2.5 0 0 1 6.5 0.5H20v16.5H6.5a2.5 2.5 0 0 0-2.5 3z"/></svg>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('PHYSIO_V50')) || { 
            user: "", 
            visits: [], 
            companies: [], 
            zones: ["Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ", "Ø§Ù„Ø¯Ù‚ÙŠ", "Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±", "Ø§Ù„Ù…Ù‚Ø·Ù…", "Ø­Ù„ÙˆØ§Ù†", "Ø§Ù„Ø¹Ø¨ÙˆØ±"],
            weeklyPlan: [[], [], [], [], []] // Ù…ØµÙÙˆÙØ© Ù…Ù† 5 Ø£ÙŠØ§Ù…ØŒ ÙƒÙ„ Ø¹Ù†ØµØ± Ù…ØµÙÙˆÙØ© Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø© (Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨)
        };
        let viewM = new Date(), selD = new Date().toDateString();
        let pressTimer, currentAdminDay = new Date().getDay(); // 0-4
        let sortableInstance = null; // Ù„ØªØ®Ø²ÙŠÙ† ÙƒØ§Ø¦Ù† Sortable
        let currentCompanyForPerson = ""; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„

        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù„Ù…Ø³ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let touchStartX = 0, touchStartY = 0;
        let touchMoved = false;

        // Ø£Ø³Ù…Ø§Ø¡ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        const dayNames = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"];

        // Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ§Ù… (true: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙˆØ¬Ø¯ Ù†ÙØ³ Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† ÙŠÙˆÙ…)
        const preventDuplicateAcrossDays = true;

        window.onload = function() { 
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø£ÙŠ ØªÙƒØ±Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
            cleanWeeklyPlan();

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ weeklyPlan
            if (!db.weeklyPlan) db.weeklyPlan = [[], [], [], [], []];
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙƒÙ„ Ø´Ø±ÙƒØ© Ù„Ø¯ÙŠÙ‡Ø§ Ø­Ù‚Ù„ notes (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            db.companies = db.companies.map(c => {
                if (!c.notes) c.notes = "";
                if (!c.plannedDays) c.plannedDays = [];
                if (!c.persons) c.persons = [];
                return c;
            });

            if (!db.user) document.getElementById('login-screen').style.display = 'flex'; 
            else runSplash(); 
            if(!document.getElementById('persons-container').children.length) addPerson(); 
            renderDayCheckboxes();
        };

        // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙÙŠ weeklyPlan
        function cleanWeeklyPlan() {
            if (!db.weeklyPlan) return;
            for (let day = 0; day < 5; day++) {
                if (db.weeklyPlan[day]) {
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
                    db.weeklyPlan[day] = [...new Set(db.weeklyPlan[day])];
                    // Ø¥Ø²Ø§Ù„Ø© Ø£Ø³Ù…Ø§Ø¡ Ø´Ø±ÙƒØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª
                    db.weeklyPlan[day] = db.weeklyPlan[day].filter(name => 
                        db.companies.some(c => c.name === name)
                    );
                } else {
                    db.weeklyPlan[day] = [];
                }
            }

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ù…ÙØ¹Ù„Ø§Ù‹ØŒ Ù†Ø²ÙŠÙ„ Ø£ÙŠ Ø´Ø±ÙƒØ© Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† ÙŠÙˆÙ…
            if (preventDuplicateAcrossDays) {
                const allCompanies = new Set();
                for (let day = 0; day < 5; day++) {
                    const uniqueForDay = [];
                    for (const name of db.weeklyPlan[day]) {
                        if (!allCompanies.has(name)) {
                            uniqueForDay.push(name);
                            allCompanies.add(name);
                        }
                    }
                    db.weeklyPlan[day] = uniqueForDay;
                }
            }
        }

        // ØªØ¹Ø¨Ø¦Ø© Checkboxes Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        function renderDayCheckboxes() {
            let html = '';
            for (let i = 0; i < 5; i++) {
                html += `<label><input type="checkbox" value="${i}"> ${dayNames[i]}</label>`;
            }
            document.getElementById('plan-days-checkboxes').innerHTML = html;
            document.getElementById('edit-plan-days-checkboxes').innerHTML = html;
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† checkboxes
        function getSelectedDays(containerId) {
            let selected = [];
            document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`).forEach(cb => {
                selected.push(parseInt(cb.value));
            });
            return selected;
        }

        // ØªØ­Ø¯ÙŠØ¯ checkboxes Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø£ÙŠØ§Ù…
        function setSelectedDays(containerId, daysArray) {
            document.querySelectorAll(`#${containerId} input[type=checkbox]`).forEach(cb => {
                cb.checked = daysArray.includes(parseInt(cb.value));
            });
        }

        function firstTimeLogin() { const u = document.getElementById('user-input').value.trim(); if(u){ db.user=u; refresh(); runSplash(); } }
        function runSplash() { 
            document.getElementById('login-screen').style.display = 'none'; 
            const s = document.getElementById('splash-screen'); 
            document.getElementById('splash-user-text').innerText = db.user; 
            s.style.display = 'flex'; 
            setTimeout(() => { s.style.opacity = '0'; s.style.transition = '0.5s'; setTimeout(() => { s.style.display = 'none'; start(); }, 500); }, 2000); 
        }
        function start() { document.getElementById('app-header').style.display='grid'; document.getElementById('app-content').style.display='block'; document.getElementById('app-nav').style.display='flex'; document.getElementById('user-display').innerText = db.user; refresh(); }

        function refresh() { 
            localStorage.setItem('PHYSIO_V50', JSON.stringify(db)); 
            renderCal(); 
            renderVisits(); 
            renderPlannedToday(); 
            renderComps(); 
            renderHubStats();
            // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
            const zOpts = db.zones.map(z=>`<option>${z}</option>`).join('') + `<option value="NEW">+ Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>`;
            document.getElementById('comp-zone').innerHTML = zOpts; 
            document.getElementById('edit-zone').innerHTML = db.zones.map(z=>`<option>${z}</option>`).join('');
            document.getElementById('comp-dl').innerHTML = db.companies.map(c=>`<option value="${c.name}">`).join(''); 
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡Ø¨ Ù…ÙØªÙˆØ­Ø§Ù‹ØŒ Ù†Ø­Ø¯Ø« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ­ÙƒÙ…
            if (document.getElementById('employee-hub').style.display === 'flex') {
                renderAdminTabs();
                renderAdminCompanyList();
                renderMultiSelectCompanies();
            }
        }

        // Ø¹Ø±Ø¶ Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙˆØ²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        function renderPlannedToday() {
            const selectedDate = new Date(selD);
            const dayOfWeek = selectedDate.getDay(); // 0 = Ø§Ù„Ø£Ø­Ø¯ ... 4 = Ø§Ù„Ø®Ù…ÙŠØ³
            if (dayOfWeek > 4) {
                document.getElementById('planned-visits').innerHTML = '<p class="card" style="text-align:center; opacity:0.7;">Ø§Ù„ÙŠÙˆÙ… Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø©</p>';
                return;
            }

            const plannedCompanyNames = db.weeklyPlan[dayOfWeek] || [];
            // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ø²ÙŠØ§Ø±ØªÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ…
            const visitedToday = new Set(db.visits.filter(v => v.date === selD).map(v => v.company));
            const companiesToShow = plannedCompanyNames.filter(name => !visitedToday.has(name));

            if (companiesToShow.length === 0) {
                document.getElementById('planned-visits').innerHTML = '<p class="card" style="text-align:center; opacity:0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…Ù‚Ø±Ø±Ø© Ù„Ù„ÙŠÙˆÙ… (Ø£Ùˆ ØªÙ…Øª Ø²ÙŠØ§Ø±ØªÙ‡Ø§)</p>';
                return;
            }

            let html = '';
            companiesToShow.forEach(name => {
                const company = db.companies.find(c => c.name === name);
                if (!company) return;
                // ØªØ¬Ù…ÙŠØ¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
                let personsHtml = '';
                if (company.persons && company.persons.length) {
                    personsHtml = '<div class="persons-list">' + company.persons.map(p => 
                        `<span class="person-badge">ğŸ‘¤ ${p.title} ${p.name}</span>`
                    ).join('') + '</div>';
                }
                html += `
                    <div class="card" style="border-right:5px solid var(--teal);">
                        <div style="display:flex; justify-content:space-between; align-items:center;" onclick="openVisitModal('${company.name.replace(/'/g, "\\'")}')">
                            <div><b>${company.name}</b><br><small>ğŸ“ ${company.zone}</small></div>
                        </div>
                        ${personsHtml}
                        <div style="margin-top:8px; text-align:left;">
                            <button class="add-person-btn" onclick="openAddPersonModal('${company.name.replace(/'/g, "\\'")}')">â•</button>
                        </div>
                    </div>`;
            });
            document.getElementById('planned-visits').innerHTML = html;
        }

        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„
        function openAddPersonModal(companyName) {
            currentCompanyForPerson = companyName;
            document.getElementById('add-person-company-name').innerText = companyName;
            document.getElementById('add-person-title').value = 'Ø¯ÙƒØªÙˆØ±';
            document.getElementById('add-person-name').value = '';
            document.getElementById('add-person-phone').value = '';
            document.getElementById('add-person-modal').style.display = 'flex';
        }

        function closeAddPersonModal() {
            document.getElementById('add-person-modal').style.display = 'none';
        }

        // Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        function saveNewPerson() {
            const companyName = currentCompanyForPerson;
            const title = document.getElementById('add-person-title').value;
            const name = document.getElementById('add-person-name').value.trim();
            const phone = document.getElementById('add-person-phone').value.trim();
            if (!name) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„');

            const company = db.companies.find(c => c.name === companyName);
            if (company) {
                if (!company.persons) company.persons = [];
                company.persons.push({ title, name, phone });
                localStorage.setItem('PHYSIO_V50', JSON.stringify(db));
                refresh();
                closeAddPersonModal();
            }
        }

        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
        function openVisitModal(companyName) {
            document.getElementById('visit-modal-company').innerText = companyName;
            document.getElementById('visit-modal-date').innerText = selD;
            document.getElementById('visit-modal-note').value = '';
            document.getElementById('visit-modal').style.display = 'flex';
        }

        function closeVisitModal() {
            document.getElementById('visit-modal').style.display = 'none';
        }

        // Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        function saveVisitFromPlan() {
            const company = document.getElementById('visit-modal-company').innerText;
            const note = document.getElementById('visit-modal-note').value.trim();
            if (!note) return alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø²ÙŠØ§Ø±Ø©');

            db.visits.push({ company, note, date: selD, timestamp: new Date().toLocaleTimeString('ar-EG') });
            refresh();
            closeVisitModal();
        }

        // Ø­ÙØ¸ Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©
        function saveNewCompany() {
            const name = document.getElementById('comp-name').value.trim();
            const zone = document.getElementById('comp-zone').value;
            if(!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©");
            
            if (db.companies.some(c => c.name === name)) {
                return alert("Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§.");
            }

            let pList = []; 
            document.querySelectorAll('#persons-container > div').forEach(d => { 
                const n = d.querySelector('.p-name').value.trim(); 
                if(n) pList.push({ title: d.querySelector('.p-title').value, name: n, phone: d.querySelector('.p-phone').value }); 
            });

            const plannedDays = getSelectedDays('plan-days-checkboxes');
            const generalNotes = document.getElementById('comp-general-notes').value.trim();

            db.companies.push({ 
                name, 
                zone, 
                persons: pList, 
                location: document.getElementById('v-location').value,
                plannedDays: plannedDays,
                notes: generalNotes
            });
            
            // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('comp-name').value=''; 
            document.getElementById('persons-container').innerHTML = ''; 
            addPerson();
            document.getElementById('v-location').value = '';
            document.getElementById('gps-status').innerText = '';
            document.getElementById('comp-general-notes').value = '';
            document.querySelectorAll('#plan-days-checkboxes input[type=checkbox]').forEach(cb => cb.checked = false);

            refresh(); 
            tab('p-home', document.querySelectorAll('.nav-link')[0]);
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù„Ù…Ø³)
        function renderComps() { 
            const s = document.getElementById('comp-search').value.toLowerCase(); 
            const f = db.companies.filter(c => c.name.toLowerCase().includes(s) || c.zone.toLowerCase().includes(s)); 
            let html = '';
            f.forEach(c => {
                const daysStr = (c.plannedDays || []).map(d => dayNames[d]).join('ØŒ ');
                html += `
                <div class="card company-item" 
                     data-name="${c.name.replace(/'/g, "\\'")}"
                     style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>${c.name}</b><br>
                        <small>ğŸ“ ${c.zone}</small><br>
                        ${daysStr ? '<small class="planned-day-badge">ğŸ—“ï¸ ' + daysStr + '</small>' : ''}
                        ${c.notes ? '<br><small>ğŸ“ ' + c.notes + '</small>' : ''}
                        ${c.persons && c.persons.length ? '<br><small>ğŸ‘¤ ' + c.persons.map(p => p.name).join(' - ') + '</small>' : ''}
                    </div>
                    <svg style="width:14px; color:var(--teal);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6" /></svg>
                </div>`;
            });
            document.getElementById('company-list').innerHTML = html;

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù„Ù…Ø³ Ù„ÙƒÙ„ Ø¹Ù†ØµØ±
            document.querySelectorAll('.company-item').forEach(item => {
                const name = item.getAttribute('data-name');
                attachTouchEvents(item, name);
            });
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ù…Ø³ Ù„Ù„ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø± ÙˆØ§Ù„ØªÙ…Ø±ÙŠØ±
        function attachTouchEvents(element, companyName) {
            let touchStartTime;
            let touchStartX, touchStartY;
            let longPressTriggered = false;

            element.addEventListener('touchstart', (e) => {
                touchStartTime = Date.now();
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchMoved = false;
                longPressTriggered = false;

                // Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
                pressTimer = setTimeout(() => {
                    longPressTriggered = true;
                    openFullEdit(companyName);
                }, 800);
            }, { passive: true });

            element.addEventListener('touchmove', (e) => {
                if (!touchStartX || !touchStartY) return;
                const dx = Math.abs(e.touches[0].clientX - touchStartX);
                const dy = Math.abs(e.touches[0].clientY - touchStartY);
                if (dx > 10 || dy > 10) {
                    touchMoved = true;
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                }
            }, { passive: true });

            element.addEventListener('touchend', (e) => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - touchStartTime;

                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ù…Ø¯Ø© Ø£Ù‚Ù„ Ù…Ù† 300 Ù…Ù„Ù„ÙŠ (Ù†Ù‚Ø±Ø© Ù‚ØµÙŠØ±Ø©) ÙˆÙ„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
                if (!touchMoved && touchDuration < 300 && !longPressTriggered) {
                    showCompDetails(companyName);
                }
            });

            // Ù„Ù„ÙØ£Ø±Ø© (Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
            element.addEventListener('mousedown', (e) => {
                touchStartTime = Date.now();
                touchMoved = false;
                longPressTriggered = false;
                pressTimer = setTimeout(() => {
                    longPressTriggered = true;
                    openFullEdit(companyName);
                }, 800);
            });

            element.addEventListener('mousemove', (e) => {
                // Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§ÙˆØ³ Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ Ù„Ø°Ø§ Ù†Ø¹ØªØ¨Ø± Ø£ÙŠ Ø­Ø±ÙƒØ© Ø¥Ù„ØºØ§Ø¡
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });

            element.addEventListener('mouseup', (e) => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                const mouseUpTime = Date.now();
                const duration = mouseUpTime - touchStartTime;
                if (!touchMoved && duration < 300 && !longPressTriggered) {
                    showCompDetails(companyName);
                }
            });
        }

        // Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ (ØªÙ… ØªØ¶Ù…ÙŠÙ†Ù‡ Ø£Ø¹Ù„Ø§Ù‡ØŒ ÙˆÙ„ÙƒÙ† Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙŠØ¶Ø§Ù‹)
        function startLongPress(name) { /* Ù„Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù† */ }
        function endLongPress(name) { /* Ù„Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù† */ }

        // ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ (Ø¶ØºØ· Ù…Ø·ÙˆÙ„)
        function openFullEdit(name) {
            const c = db.companies.find(co => co.name === name);
            if(!c) return;
            document.getElementById('edit-original-name').value = c.name;
            document.getElementById('edit-name').value = c.name;
            document.getElementById('edit-zone').value = c.zone;
            setSelectedDays('edit-plan-days-checkboxes', c.plannedDays || []);

            const cont = document.getElementById('edit-persons-container');
            cont.innerHTML = '';
            (c.persons || []).forEach(p => addPersonToEdit(p));

            document.getElementById('edit-general-notes').value = c.notes || '';
            
            const vs = db.visits.filter(v => v.company === name);
            document.getElementById('edit-last-note').value = vs.length ? vs[vs.length-1].note : "";
            
            document.getElementById('edit-full-modal').style.display = 'flex';
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø¹ Ø²Ø± Ø¥Ø²Ø§Ù„Ø©)
        function addPersonToEdit(data = null) {
            const container = document.getElementById('edit-persons-container');
            const div = document.createElement('div');
            div.className = 'person-edit-row';
            div.innerHTML = `
                <select class="input ep-title" style="width:85px;">
                    <option ${data?.title==='Ø¯ÙƒØªÙˆØ±'?'selected':''}>Ø¯ÙƒØªÙˆØ±</option>
                    <option ${data?.title==='Ø£Ø³ØªØ§Ø°'?'selected':''}>Ø£Ø³ØªØ§Ø°</option>
                    <option ${data?.title==='Ø£Ø³ØªØ§Ø°Ø©'?'selected':''}>Ø£Ø³ØªØ§Ø°Ø©</option>
                </select>
                <input type="text" class="input ep-name" placeholder="Ø§Ù„Ø§Ø³Ù…" value="${data?.name||''}">
                <input type="tel" class="input ep-phone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" value="${data?.phone||''}">
                <button class="delete-btn small" onclick="removePersonFromEdit(this)" title="Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">Ø¥Ø²Ø§Ù„Ø©</button>
            `;
            container.appendChild(div);
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù…Ø³Ø¤ÙˆÙ„ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function removePersonFromEdit(btn) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ØŸ')) {
                const row = btn.closest('.person-edit-row');
                if (row) row.remove();
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        function deleteCompanyFromEdit() {
            const companyName = document.getElementById('edit-original-name').value;
            if (!companyName) return;
            
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø±ÙƒØ© "${companyName}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ø£ÙŠØ¶Ø§Ù‹.`)) {
                // Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª
                db.companies = db.companies.filter(c => c.name !== companyName);
                
                // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©
                db.visits = db.visits.filter(v => v.company !== companyName);
                
                // Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…)
                for (let day = 0; day < 5; day++) {
                    db.weeklyPlan[day] = db.weeklyPlan[day].filter(name => name !== companyName);
                }
                
                localStorage.setItem('PHYSIO_V50', JSON.stringify(db));
                closeEditFullModal();
                refresh(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
            }
        }

        function saveFullEdit() {
            const oldN = document.getElementById('edit-original-name').value;
            const newN = document.getElementById('edit-name').value.trim();
            const newZ = document.getElementById('edit-zone').value;
            const newPlannedDays = getSelectedDays('edit-plan-days-checkboxes');
            const newNotes = document.getElementById('edit-general-notes').value.trim();
            
            if(!newN) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
            
            let pList = [];
            document.querySelectorAll('#edit-persons-container .person-edit-row').forEach(row => {
                const title = row.querySelector('.ep-title').value;
                const name = row.querySelector('.ep-name').value.trim();
                const phone = row.querySelector('.ep-phone').value.trim();
                if (name) pList.push({ title, name, phone });
            });

            const cIdx = db.companies.findIndex(c => c.name === oldN);
            if(cIdx !== -1) {
                db.companies[cIdx].name = newN;
                db.companies[cIdx].zone = newZ;
                db.companies[cIdx].persons = pList;
                db.companies[cIdx].plannedDays = newPlannedDays;
                db.companies[cIdx].notes = newNotes;
                
                db.visits.forEach(v => {
                    if(v.company === oldN) {
                        v.company = newN;
                        if(v === db.visits.filter(x => x.company === newN).pop()) v.note = document.getElementById('edit-last-note').value;
                    }
                });
                // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙÙŠ weeklyPlan Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ø§Ø³Ù…
                for (let day=0; day<5; day++) {
                    db.weeklyPlan[day] = db.weeklyPlan[day].map(n => n === oldN ? newN : n);
                }
                refresh();
                closeEditFullModal();
            }
        }

        function closeEditFullModal() { document.getElementById('edit-full-modal').style.display = 'none'; }

        // Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
        function renderCal() { 
            const grid = document.getElementById('calendar'); grid.innerHTML = ''; 
            const y = viewM.getFullYear(), m = viewM.getMonth(); 
            document.getElementById('month-label').innerText = viewM.toLocaleDateString('ar-EG', {month:'long', year:'numeric'}); 
            const first = new Date(y, m, 1).getDay(); const days = new Date(y, m+1, 0).getDate(); 
            for(let i=0; i<first; i++) grid.innerHTML += '<div></div>'; 
            for(let d=1; d<=days; d++) { 
                let dStr = new Date(y, m, d).toDateString(); 
                grid.innerHTML += `<div class="day ${dStr === selD ? 'selected' : ''} ${db.visits.some(v=>v.date===dStr)?'has-v':''}" onclick="selD='${dStr}'; refresh();">${d}</div>`; 
            } 
        }

        function renderVisits() { const f = db.visits.filter(v => v.date === selD); document.getElementById('daily-visits').innerHTML = f.map(v => `<div class="card" style="border-right:5px solid var(--teal)"><b>${v.company}</b><br><small>${v.note}</small></div>`).join('') || '<p style="text-align:center; opacity:0.5;">Ù„Ø§ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>'; }
        
        function showCompDetails(name) { 
            const c = db.companies.find(co => co.name === name); 
            const vs = db.visits.filter(v => v.company === name); 
            document.getElementById('modal-title').innerText = c.name; 
            let h = `<p><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${c.zone}</p>`; 
            if (c.plannedDays && c.plannedDays.length) {
                h += `<p><b>Ø£ÙŠØ§Ù… Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</b> ${c.plannedDays.map(d => dayNames[d]).join(' - ')}</p>`;
            }
            if (c.notes) h += `<p><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:</b> ${c.notes}</p>`;
            if(c.location) h += `<p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> <a href="${c.location}" target="_blank" style="color:var(--teal);">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ğŸ“</a></p>`; 
            h += `<hr><h4>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†:</h4>`; (c.persons||[]).forEach(p => h += `<p>â€¢ ${p.title}/ ${p.name} (${p.phone})</p>`); 
            h += `<hr><h4>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª:</h4>`; vs.forEach(v => h += `<p style="font-size:12px; border-bottom:1px solid #eee; padding:5px 0;">ğŸ“… ${v.date}: ${v.note}</p>`); 
            document.getElementById('modal-content').innerHTML = h; 
            document.getElementById('details-modal').style.display = 'flex'; 
        }
        
        function addPerson() { 
            const div = document.createElement('div'); div.style.display = "flex"; div.style.gap = "5px"; div.style.marginBottom = "8px"; 
            div.innerHTML = `<select class="input p-title" style="width:90px;"><option>Ø¯ÙƒØªÙˆØ±</option><option>Ø£Ø³ØªØ§Ø°</option><option>Ø£Ø³ØªØ§Ø°Ø©</option></select><input type="text" class="input p-name" placeholder="Ø§Ù„Ø§Ø³Ù…" style="flex:1;"><input type="tel" class="input p-phone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" style="flex:1;">`; 
            document.getElementById('persons-container').appendChild(div); 
        }

        function getLocation() { const s = document.getElementById('gps-status'); if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((pos) => { document.getElementById('v-location').value = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`; s.innerText = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…"; }, () => { s.innerText = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹."; }); } }

        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function renderHubStats() {
            const mVisits = db.visits.filter(v => {
                const d = new Date(v.date);
                return d.getMonth() === viewM.getMonth() && d.getFullYear() === viewM.getFullYear();
            });
            document.getElementById('st-visits').innerText = mVisits.length;
            document.getElementById('st-comps').innerText = new Set(mVisits.map(v => v.company)).size;
            let pct = Math.min(Math.round((mVisits.length / 60) * 100), 100);
            document.getElementById('target-bar').style.width = pct + '%';
            document.getElementById('target-pct').innerText = pct + '%';
            let zCounts = {};
            mVisits.forEach(v => {
                const c = db.companies.find(co => co.name === v.company);
                if(c) zCounts[c.zone] = (zCounts[c.zone] || 0) + 1;
            });
            let sorted = Object.entries(zCounts).sort((a,b) => b[1]-a[1]).slice(0,3);
            document.getElementById('top-zones').innerHTML = sorted.map(z => `<div class="tag-item">${z[0]} (${z[1]})</div>`).join('') || '<small>Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</small>';
        }

        // Ø¯ÙˆØ§Ù„ PDF ÙˆØ§Ù„ØªØµØ¯ÙŠØ± (Ù…Ø­Ø³Ù†Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ±)
        function downloadMonthlyPDF() {
            const mVisits = db.visits.filter(v => {
                const d = new Date(v.date);
                return d.getMonth() === viewM.getMonth() && d.getFullYear() === viewM.getFullYear();
            });
            if(!mVisits.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±");
            generatePDF(mVisits, `ØªÙ‚Ø±ÙŠØ±_Ø´Ù‡Ø±_${viewM.getMonth()+1}`);
        }

        function downloadPDF() {
            const vT = db.visits.filter(v => v.date === selD);
            if(!vT.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…");
            generatePDF(vT, `ØªÙ‚Ø±ÙŠØ±_ÙŠÙˆÙ…_${selD}`);
        }

        function generatePDF(data, fileName) {
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ù„Ø¨
            document.getElementById('pdf-user').innerText = db.user;
            document.getElementById('pdf-period').innerText = fileName.replace(/_/g, ' ');
            document.getElementById('pdf-date').innerText = new Date().toLocaleDateString('ar-EG');

            let rows = "";
            data.forEach(v => {
                const c = db.companies.find(co => co.name === v.company) || {};
                const p = c.persons && c.persons[0] ? c.persons[0].name : '-';
                rows += `<tr>
                    <td>${v.company}</td>
                    <td>${c.zone || '-'}</td>
                    <td>${p}</td>
                    <td>${v.note}</td>
                    <td>${v.timestamp || ''}</td>
                </tr>`;
            });
            document.getElementById('pdf-body').innerHTML = rows;

            const el = document.getElementById('pdf-template');
            el.style.display = 'block';
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„Ù€ html2pdf - Ø£Ù‡Ù… Ù†Ù‚Ø·Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬ÙˆØ¯Ø©
            const opt = {
                margin: [15, 15, 15, 15], // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‡ÙˆØ§Ù…Ø´
                filename: `${fileName}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { 
                    scale: 2.5,          // Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
                    useCORS: true, 
                    letterRendering: true,
                    logging: false,
                    dpi: 300
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            };

            html2pdf().from(el).set(opt).save().then(() => {
                el.style.display = 'none';
            });
        }

        function shareWA() {
            const f = db.visits.filter(v => v.date === selD);
            if(!f.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª");
            let fullMsg = "*ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…*%0A";
            f.forEach(v => {
                const c = db.companies.find(co => co.name === v.company) || {};
                fullMsg += `%0AğŸ“ ${c.zone} | ğŸ¢ ${v.company}%0AğŸ“ ${v.note}%0Aâ° ${v.timestamp}%0A---%0A`;
            });
            window.open(`https://wa.me/?text=${fullMsg}`);
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‡Ø¨
        function toggleHub(show) { 
            document.getElementById('employee-hub').style.display = show ? 'flex' : 'none'; 
            if (show) {
                // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
                renderAdminTabs();
                renderAdminCompanyList();
                renderMultiSelectCompanies();
            }
        }

        function switchHubTab(tab) {
            document.querySelectorAll('.hub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.hub-tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'stats') {
                document.querySelector('.hub-tab').classList.add('active');
                document.getElementById('hub-stats').classList.add('active');
            } else {
                document.querySelectorAll('.hub-tab')[1].classList.add('active');
                document.getElementById('hub-control').classList.add('active');
                // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„ÙŠÙ‡
                renderAdminTabs();
                renderAdminCompanyList();
                renderMultiSelectCompanies();
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… (Ù…Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
        function renderAdminTabs() {
            const tabsContainer = document.getElementById('admin-days-tabs');
            if (!tabsContainer) return;
            let html = '';
            for (let i = 0; i < 5; i++) {
                html += `<div class="admin-day-tab ${i === currentAdminDay ? 'active' : ''}" onclick="setAdminDay(${i})">${dayNames[i]}</div>`;
            }
            tabsContainer.innerHTML = html;
        }

        function setAdminDay(dayIndex) {
            currentAdminDay = dayIndex;
            renderAdminCompanyList();
            renderMultiSelectCompanies();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            document.querySelectorAll('#admin-days-tabs .admin-day-tab').forEach((tab, idx) => {
                if (idx === dayIndex) tab.classList.add('active');
                else tab.classList.remove('active');
            });
        }

        function renderAdminCompanyList() {
            const listContainer = document.getElementById('admin-company-list');
            if (!listContainer) return;
            const companiesForDay = db.weeklyPlan[currentAdminDay] || [];
            
            if (companiesForDay.length === 0) {
                listContainer.innerHTML = '<p class="card" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>';
                return;
            }

            let html = '';
            companiesForDay.forEach((companyName) => {
                const company = db.companies.find(c => c.name === companyName);
                if (!company) return;
                html += `
                    <div class="plan-company-row" data-company="${company.name.replace(/'/g, "\\'")}">
                        <span class="drag-handle">â˜°</span>
                        <div class="plan-company-info" onclick="showCompDetails('${company.name.replace(/'/g, "\\'")}')">
                            <b>${company.name}</b><br>
                            <small>ğŸ“ ${company.zone}</small>
                        </div>
                        <button class="delete-btn small" onclick="removeCompanyFromDay('${company.name.replace(/'/g, "\\'")}')" title="Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø®Ø·Ø©">Ø¥Ø²Ø§Ù„Ø©</button>
                    </div>`;
            });
            listContainer.innerHTML = html;

            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ (drag and drop) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SortableJS
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(listContainer, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: function(evt) {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const newOrder = [];
                    const items = listContainer.querySelectorAll('.plan-company-row');
                    items.forEach(item => {
                        const companyName = item.getAttribute('data-company');
                        if (companyName) newOrder.push(companyName);
                    });
                    db.weeklyPlan[currentAdminDay] = newOrder;
                    localStorage.setItem('PHYSIO_V50', JSON.stringify(db));
                    refresh(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                }
            });
        }

        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
        function renderMultiSelectCompanies() {
            const container = document.getElementById('multi-select-companies');
            if (!container) return;
            
            // Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            const existingInCurrentDay = new Set(db.weeklyPlan[currentAdminDay] || []);
            
            let available;
            if (preventDuplicateAcrossDays) {
                // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø£ÙŠ ÙŠÙˆÙ…
                const allUsed = new Set();
                for (let day = 0; day < 5; day++) {
                    (db.weeklyPlan[day] || []).forEach(name => allUsed.add(name));
                }
                available = db.companies.filter(c => !allUsed.has(c.name));
            } else {
                // ÙÙ‚Ø· Ø§Ù„Ø´Ø±ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
                available = db.companies.filter(c => !existingInCurrentDay.has(c.name));
            }
            
            if (available.length === 0) {
                container.innerHTML = '<p style="text-align:center;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„</p>';
                return;
            }

            let html = '';
            available.forEach(company => {
                html += `
                    <div class="multi-select-item">
                        <input type="checkbox" value="${company.name.replace(/'/g, "&apos;")}" id="chk_${company.name.replace(/[^a-zA-Z0-9]/g, '_')}">
                        <label for="chk_${company.name.replace(/[^a-zA-Z0-9]/g, '_')}">${company.name} (${company.zone})</label>
                    </div>`;
            });
            container.innerHTML = html;
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ÙŠÙˆÙ… Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        function addSelectedCompanies() {
            const checkboxes = document.querySelectorAll('#multi-select-companies input[type=checkbox]:checked');
            if (checkboxes.length === 0) {
                alert('Ù„Ù… ØªØ®ØªØ§Ø± Ø£ÙŠ Ø´Ø±ÙƒØ©');
                return;
            }

            const selected = [];
            checkboxes.forEach(cb => {
                selected.push(cb.value);
            });

            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: Ù†Ø£Ø®Ø° ÙÙ‚Ø· Ø§Ù„ØªÙŠ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            const existingInCurrentDay = new Set(db.weeklyPlan[currentAdminDay] || []);
            let newCompanies = selected.filter(name => !existingInCurrentDay.has(name));

            if (preventDuplicateAcrossDays) {
                // Ù†ØªØ£ÙƒØ¯ Ø£ÙŠØ¶Ø§Ù‹ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯Ù‡Ø§ ÙÙŠ Ø£ÙŠ ÙŠÙˆÙ… Ø¢Ø®Ø±
                const allUsed = new Set();
                for (let day = 0; day < 5; day++) {
                    if (day !== currentAdminDay) {
                        (db.weeklyPlan[day] || []).forEach(name => allUsed.add(name));
                    }
                }
                const duplicatesAcrossDays = newCompanies.filter(name => allUsed.has(name));
                if (duplicatesAcrossDays.length > 0) {
                    alert(`Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø£ÙŠØ§Ù… Ø£Ø®Ø±Ù‰ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§: ${duplicatesAcrossDays.join('ØŒ ')}`);
                    // Ù†Ø²ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    newCompanies = newCompanies.filter(name => !allUsed.has(name));
                }
            }

            if (newCompanies.length === 0) {
                alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„');
                return;
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            if (!db.weeklyPlan[currentAdminDay]) db.weeklyPlan[currentAdminDay] = [];
            db.weeklyPlan[currentAdminDay] = [...db.weeklyPlan[currentAdminDay], ...newCompanies];

            localStorage.setItem('PHYSIO_V50', JSON.stringify(db));
            renderAdminCompanyList();
            renderMultiSelectCompanies();
            refresh();
        }

        function removeCompanyFromDay(companyName) {
            db.weeklyPlan[currentAdminDay] = db.weeklyPlan[currentAdminDay].filter(n => n !== companyName);
            localStorage.setItem('PHYSIO_V50', JSON.stringify(db));
            renderAdminCompanyList();
            renderMultiSelectCompanies();
            refresh();
        }

        // Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰
        function closeModal() { document.getElementById('details-modal').style.display = 'none'; }
        function moveMonth(n) { viewM.setMonth(viewM.getMonth()+n); refresh(); }
        function tab(id, el) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
            el.classList.add('active'); 
        }
        function checkNewZone(sel) { if(sel.value === "NEW") { const n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:"); if(n) { db.zones.push(n); refresh(); sel.value = n; } else sel.selectedIndex = 0; } }
        function toggleDrop() { document.getElementById("reportDrop").classList.toggle("show"); }
        function exportData() { const blob = new Blob([JSON.stringify(db)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Physio_Backup_${new Date().toLocaleDateString()}.json`; a.click(); }
        function importData(e) { const r = new FileReader(); r.onload = ev => { try { db = JSON.parse(ev.target.result); 
            db.companies = db.companies.map(c => { if (!c.plannedDays) c.plannedDays = []; if (!c.notes) c.notes = ""; if (!c.persons) c.persons = []; return c; });
            if (!db.weeklyPlan) db.weeklyPlan = [[], [], [], [], []];
            cleanWeeklyPlan(); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
            refresh(); alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…"); } catch(err) { alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"); } }; r.readAsText(e.target.files[0]); }
    </script>
</body>
</html>